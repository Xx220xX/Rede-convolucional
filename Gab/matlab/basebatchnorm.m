clc;clear all;close all;
a = [-0.1652506142854691, 0.8262844681739807, 1.1606101989746094, 0.0125732757151127, -0.8023995161056519, -0.7589943408966065, -0.0804874524474144, 0.1418175548315048, 2.0602929592132568, 1.2539244890213013, 0.3323907554149628, -1.7759163379669189, -2.0332655906677246, 2.1604921817779541, 1.8023753166198730, 0.7432328462600708, -1.2525085210800171, -0.1041194722056389, 1.1316771507263184, 0.4404882788658142, 0.2830849289894104, 0.1646324247121811, 0.6174915432929993, -0.4094128012657166, -1.2218503952026367, 1.6091108322143555, -1.7176702022552490, -1.3305439949035645, -0.0522367917001247, 0.8437575101852417, 0.6780604720115662, 0.9537628889083862, -0.9441447257995606, -1.9007575511932373, -0.2515891492366791, 0.1013076603412628, -1.2379636764526367, 0.2816838920116425, 2.1375231742858887, 0.9262206554412842, 1.6448601484298706, -1.3823810815811157, 1.9743679761886597, 0.1069467291235924, 0.2506206035614014, -1.1463483572006226, -0.8611757755279541, -0.5052970647811890, -2.4632570743560791, 0.5708417892456055, -1.2194944620132446, -0.1042304933071137, -0.5158516168594360, 0.4803927242755890, -0.6472374796867371, -0.5305232405662537, -0.2321432977914810, -0.7281754016876221, 0.3462799191474915, 2.0071938037872314, 0.1445086300373077, 0.4072799682617188, 0.4379478991031647, -1.4415140151977539, 0.5058099627494812, 0.4962238371372223, 1.6004432439804077, 0.8960515856742859, -0.4411080479621887, 1.4556857347488403, 1.0589520931243896, 2.3515992164611816, 1.4891499280929565, -0.3674939274787903, -2.0088458061218262, -2.5906705856323242, -0.3376788794994354, 0.3745706379413605, 0.6768023967742920, 1.5591758489608765, 1.3444733619689941, -1.6937166452407837, 0.0563259646296501, 0.1190168336033821, -1.3784583806991577, -1.1212306022644043, 1.2125854492187500, 0.1042848676443100, -1.5696182250976563, -0.2865770459175110, -0.7842403650283814, -0.2132184803485870, -1.1831843852996826, -0.5775086879730225, -1.9278516769409180, 0.4441545903682709, -0.0793975666165352, 0.4558744132518768, -0.2006488591432571, -0.2727059125900269, -0.8381699323654175, 1.1447664499282837, 0.8530459403991699, 1.4571498632431030, -0.3909333646297455, 0.5344020128250122, 0.6786806583404541, -0.2708616554737091, 0.2063090056180954, 1.6453398466110229, 0.6220211982727051, 1.1231130361557007, 1.0902670621871948, -1.1224220991134644, 1.4132488965988159, 1.5518305301666260, -0.5730931162834168, 0.6054774522781372, -1.4917607307434082, -0.3848919868469238, -0.7290660142898560, -0.2604788243770599, -1.5230102539062500, -0.3299228549003601, -0.1679949462413788, -0.4324525892734528, -2.3848938941955566, -1.5946162939071655, 0.3253564238548279, -0.7128085494041443, 0.3195801377296448, -0.8540108203887940, -2.5440397262573242, 0.1182119399309158, 0.2227493226528168, 0.0793858617544174, 1.5742462873458862, -0.2263486087322235, -1.4324332475662231, -0.7148047089576721, -0.8981180787086487, -0.6278634071350098, -0.8993105292320252, -0.8139314651489258, 1.5269510746002197, -0.3754144310951233, -0.2521149814128876, -0.3771760165691376, 0.6245353817939758, 0.2124645262956619, -0.7986462116241455, -2.5797638893127441, -1.1023881435394287, 2.8063142299652100, -2.3654034137725830, 0.2981722652912140, 0.1180459558963776, 0.1913816928863525, -0.0463817715644836, -1.4759590625762939, -0.2796438336372376, 0.9294932484626770, -2.2358930110931396, -0.6254161596298218, 2.8244140148162842, -1.4224086999893188, -0.6296931505203247, 0.0267237257212400, -0.6307955384254456, -1.1372774839401245, 0.3690122365951538, 0.1892886906862259, -1.5658187866210938, -0.4664555788040161, 0.8640373349189758, 0.6659436821937561, -0.2915492951869965, -0.0145688969641924, -2.5789787769317627, -0.1021019592881203, -0.3588667511940002, -1.6486014127731323, 0.6623174548149109, 0.2912867367267609, 0.2634911835193634, -0.6150619983673096, -1.3581089973449707, 0.6554626822471619, 1.7920870780944824, 0.8734282255172730, -2.2300825119018555, -2.6979436874389648, -1.0891946554183960, 0.4354690313339233, 1.7882999181747437, -0.1567423939704895, -0.0048417281359434, 1.3171437978744507, -0.3792472183704376, -0.4088136851787567, 0.6417810320854187, 0.2690910398960114, -0.3579730689525604, 0.6214439272880554, 2.2830319404602051, 0.2816992998123169, -1.0048458576202393, -0.2045467346906662, -0.8074497580528259, 2.6339113712310791, 1.4810458421707153, 0.2315816730260849, 1.3044415712356567, -1.8455862998962402, 1.0551360845565796, -0.8586043119430542, 0.1741466522216797, 1.2613071203231812, -1.3998622894287109, -0.9347084164619446, 0.2875361442565918, 0.2002352923154831, 0.6647394895553589, 0.0327390506863594, 0.1625364571809769, 0.2403202950954437, -0.6107547879219055, -0.3869170844554901, 1.0791065692901611, -2.1442258358001709, -0.2370802462100983, 2.2442679405212402, 0.2360219657421112, 0.6054146289825440, -1.0117826461791992, -1.2532505989074707, -0.2535447180271149, -1.0007464885711670, 1.9869209527969360, -0.8511996865272522, -0.6860710978507996, 0.5489017963409424, -1.1623286008834839, 1.2552263736724854, 0.1673659682273865, 1.8373187780380249, 0.7798227667808533, -0.3293126821517944, -0.1784711182117462, 0.6439992189407349, -0.6882739067077637, 0.0864963829517365, 0.5902928113937378, -0.1257665902376175, -3.7341306209564209, -0.1920323073863983, -0.4105894267559052, -0.4670804440975189, -0.4286611378192902, 0.0283864326775074, -0.3823942244052887, -0.0825438797473907, -0.6831149458885193, 0.9068424701690674, -0.8121756911277771, -0.9146881699562073, 0.4297959208488464, 1.3475295305252075, -1.9203125238418579, -0.5487797260284424, -0.2675200104713440, 0.7948508262634277, 0.5058690309524536, -2.3052887916564941, -0.5555850863456726, 0.0697483941912651, 0.7264698147773743, -0.9119265079498291, -0.1498830616474152, 0.0171696338802576, -0.0812059938907623, -2.7293086051940918, -1.6013814210891724, 1.0325509309768677, -0.4599263668060303, 0.0148934954777360, -1.5202932357788086, 3.2025630474090576, -1.0589176416397095, 0.1765646934509277, -0.9331996440887451, -1.9094026088714600, -0.9654952883720398, 0.9154070019721985, -0.9136103391647339, -1.0945007801055908, -1.0198397636413574, 0.5159755349159241, -2.1176242828369141, -2.2683854103088379, -0.6662557125091553, 0.2939268052577972, -0.9311545491218567, 1.1900099515914917, 0.6614099740982056, 0.2872333824634552, 0.1250338554382324, -1.1386922597885132, 0.5811699628829956, 0.6660097837448120, 0.7985721230506897, -1.1549061536788940, -0.8613250851631165, -0.9552267193794251, -0.1044854298233986, 0.0208038575947285, 0.3564912676811218, 1.2215328216552734, 0.8081253170967102, -0.1318072974681854, -0.4696989357471466, -0.2765444219112396, -0.1905232518911362, 0.1728377044200897, 1.5880303382873535, -0.3645130991935730, 0.7491778135299683, -1.5641714334487915, 0.8306993842124939, 0.0895041674375534, 1.2929648160934448, -0.7248039841651917, 0.7655143141746521, 1.6502112150192261, 1.3995158672332764, 2.1418151855468750, 0.8201984763145447, 1.2351748943328857, 2.0891442298889160, -1.7892725467681885, -0.5406597852706909, -0.9078292250633240, -0.4069873392581940, -0.6323919892311096, 1.3256287574768066, -1.4535837173461914, -1.2158292531967163, -0.9919450879096985, 0.9685839414596558, -0.5625559091567993, -0.0284898430109024, -0.4482929706573486, -0.9300267100334168, -2.3298509120941162, -0.4584102630615234, 0.9735487699508667, -0.2344151437282562, -2.2042689323425293, -0.7379515171051025, -1.1137742996215820, 0.5393491983413696, 0.3701779842376709, 0.0698550269007683, 0.5791873931884766, -0.9062688350677490, 0.2526149451732636, -0.3899003863334656, 0.9916791915893555, -0.0702266618609428, 1.0840228796005249, -0.0539227165281773, 0.5883582234382629, -0.2325327694416046, -0.3250424861907959, 0.8217527270317078, 1.2123379707336426, 1.7849850654602051, 0.4672169387340546, 1.2757955789566040, -1.0269036293029785, 0.8467894196510315, 0.2922040224075317, -0.1526966243982315, -0.1921134144067764, 0.2020265012979507, -1.9143583774566650, 0.0408902205526829, 1.6353094577789307, 1.2746450901031494, 0.9298723936080933, 1.4016146659851074, -0.1822223812341690, 0.1370983868837357, 1.0773277282714844, -1.4184244871139526, 0.7216680049896240, 0.0082068536430597, 0.0417012423276901, -0.1174747198820114, 0.4027353227138519, -1.4166504144668579, -0.1388536840677261, 0.9797263145446777, -0.8840642571449280, -0.6239111423492432, -0.4056044816970825, 0.3376672267913818, -0.2694968581199646, 0.2828947901725769, -2.2668859958648682, -1.0290561914443970, -0.1312579363584518, 0.4524077177047730, 0.3481634855270386, -0.3865535259246826, 0.4235184788703919, -0.5492318272590637, 0.2318947911262512, 0.1741483509540558, 1.3763928413391113, -0.2373364716768265, 1.3457905054092407, 0.6958423256874085, 0.6908112764358521, -0.4147351384162903, -0.6501307487487793, 1.0411038398742676, -0.1058164536952972, 0.2211220115423203, 1.9056884050369263, 1.6825437545776367, -0.3343403935432434, -0.1031313836574554, 0.2573076486587524, -1.4125480651855469, -0.3333333730697632, -1.0623003244400024, -0.2202998846769333, 0.7824906706809998, -1.2572478055953979, 0.5355617403984070, -2.7392828464508057, 1.3588765859603882, -0.7858666777610779, 1.7740255594253540, -0.3868913352489471, -0.7884383201599121, 0.9685099124908447, 0.7990853786468506, -0.0367784798145294, 2.1042993068695068, -1.2658616304397583, -0.0728002563118935, -0.3998669385910034, -0.3213385045528412, 2.3459019660949707, 0.2202674746513367, -0.6440783143043518, 1.5070753097534180, -0.0840587466955185, -0.0024583695922047, 0.5746036171913147, 1.1029225587844849, -0.7042642235755920, 0.6819869279861450, -1.6322151422500610, -0.8610260486602783, 0.8865554332733154, -1.0686002969741821, -1.7498229742050171, -1.7875756025314331, 1.3816057443618774, 2.1424205303192139, -0.0183657091110945, 0.2675884664058685, -1.0807373523712158, -0.1611559689044952, -0.4051465690135956, -0.8062176704406738, 0.6788257360458374, -0.8328882455825806, 1.6677192449569702, -0.2382319718599320, 0.3112741708755493, -1.2526292800903320, -0.0629029124975204, -1.8284968137741089, 0.6330138444900513, 1.5910943746566772, -0.6362579464912415, 0.3816752731800079, 0.0082980012521148, -1.7635444402694702, -0.7685470581054688, -0.8986995220184326, -0.5431475639343262, 0.9377430081367493, -0.5601386427879334, -0.0916907787322998, 0.5728293061256409, 1.1960301399230957, -0.1503627300262451, -1.3713133335113525, -1.9910118579864502, -0.6411572098731995, 0.4676651358604431, -1.3409769535064697, 1.3727869987487793, -0.3395902216434479, -0.4578217864036560, -0.6755995750427246, 1.0638355016708374, -1.1863036155700684, 1.7635978460311890, -0.6454894542694092, 0.0616757087409496, -0.1390517652034760, -0.3499830961227417, 0.1164546534419060, -2.7739558219909668, 1.2887524366378784, 0.5812538266181946, -0.5352505445480347, -1.1137771606445313, 0.3862931132316589, 0.4078097343444824, -1.7958972454071045, -0.6138074398040772, -0.7119688391685486, 1.7918380498886108, -0.8774656653404236, -0.7817781567573547, -0.1912443190813065, -1.6359277963638306, -0.5270061492919922, 1.3053951263427734, 0.9113792777061462, -0.5703573226928711, -1.3737679719924927, 1.2005026340484619, -0.3452125489711762, -0.6392288208007813, -0.9758157730102539, -0.9056269526481628, -0.0584914498031139, -1.2384397983551025, 0.5447399616241455, -0.2379389554262161, 1.4165524244308472, 0.0124344490468502, -1.7259063720703125, 0.6011788845062256, -1.3275665044784546, -0.8206321597099304, 0.6872605681419373, 0.1787450909614563, -0.6479545831680298, -0.4490498304367065, -0.2563223540782929, 0.0740207508206367, 1.4372233152389526, -0.6994131803512573, -0.7209210991859436, 1.1895440816879272, -0.8643137812614441, 0.8441981673240662, -0.1325417011976242, 0.8442227244377136, -0.2034121155738831, 0.9153059124946594, -1.4186503887176514, -1.0302779674530029, -0.8139278888702393, 1.1480740308761597, -0.7619332671165466, 0.4633161723613739, 0.3636946082115173, -0.7525976896286011, 0.9485603570938110, 0.4440981745719910, 1.7741651535034180, -1.0701562166213989, 0.3198682069778442, 0.5495319962501526, 0.0122189046815038, -0.9427964091300964, -0.5698488354682922, -0.3401900529861450, 0.8070005178451538, -1.6005520820617676, -1.4321484565734863, -1.6952862739562988, 1.1865077018737793, 0.2095959037542343, -0.7263753414154053, -0.7817720770835877, 0.9955778121948242, -0.1605005711317062, 0.6687594652175903, -0.4001796245574951, -0.3229924738407135, 3.0857393741607666, -0.0467705689370632, -0.2526329457759857, 0.3430439531803131, -0.7458810210227966, -1.1547902822494507, -0.5045241117477417, -0.2640279829502106, 2.1830739974975586, -2.6078214645385742, 0.2090932279825211, 0.4764604568481445, -0.2295916825532913, 0.8909165859222412, -0.3265193998813629, -1.3228414058685303, 0.0560480318963528, 0.5075224041938782, 0.1854413747787476, -0.9758103489875794, -1.2493594884872437, 0.7758222222328186, -2.7800207138061523, -1.0906428098678589, -0.1232859268784523, 0.7945953011512756, 0.4362460970878601, 0.2279497534036636, 1.4858732223510742, 1.5591512918472290, -0.8559526205062866, 0.1698462814092636, -0.0574199073016644, 1.5975722074508667, 0.9738825559616089, -0.0895170196890831, 1.8464210033416748, 0.3321748673915863, 0.2860266268253326, -0.1601857990026474, 0.0118088982999325, 0.1260525882244110, -2.3093116283416748, 0.1373461186885834, 0.7316606640815735, 0.8402063846588135, -0.2600215375423431, -0.6095087528228760, 1.3428373336791992, 1.1527612209320068, -1.3427172899246216, 0.1374809443950653, 0.2607430219650269, -1.3311702013015747, -0.8049224019050598, 0.2644931375980377, -0.0596603639423847, 0.9003919959068298, 1.2100837230682373, -0.7781455516815186, 0.5120351314544678, -0.2199282944202423, -0.5671325325965881, 1.1330283880233765, 0.1363688111305237, 0.0751459598541260, 0.7251125574111939, -0.4943205416202545, 1.5271408557891846, -0.5460748076438904, 0.1801358908414841, 0.0354318954050541, -1.4129416942596436, 1.2462300062179565, 0.8895905017852783, 1.1573368310928345, 0.0854393616318703, -0.0548844300210476, 1.6502690315246582, -0.4624176323413849, -0.1795401871204376, 0.4733393788337708, -1.0215190649032593, 0.8196602463722229, 0.2896646857261658, 1.2897552251815796, -0.7913705706596375, 0.4651196599006653, -0.5430214405059815, 0.5484227538108826, 0.2488374412059784, -0.3764607906341553, -0.1886681020259857, 0.1326895058155060, -0.7349840402603149, -1.2328938245773315, -0.0191207472234964, 1.2993654012680054, 0.0251589491963387, 0.2202423959970474, 0.5606459379196167, 0.4573645889759064, 0.4877855479717255, -1.8795835971832275, 0.0035597484093159, -1.4406551122665405, 0.7154822349548340, -0.8293116092681885, -1.7430373430252075, -0.9076488018035889, -1.1291975975036621, 0.3867554962635040, -0.0674042180180550, 0.7276875972747803, 0.6805820465087891, 0.3731955885887146, -1.0885943174362183, 0.7138175964355469, -0.5105996131896973, -0.1510918289422989, -0.3094508647918701, -1.2225879430770874, -1.7189266681671143, -0.3528247177600861, -0.1513989865779877, -0.6147732734680176, 1.4390823841094971, 0.8013076782226563, 0.7328653931617737, -0.6758635640144348, -1.5087357759475708, -2.0162727832794189, -0.3153233826160431, 0.0773192346096039, 0.4133934676647186, 0.2330272346735001, 0.1692176461219788, 0.6834124326705933, -0.5334168672561646, 1.6196763515472412, -1.2903472185134888, -1.3894941806793213, -0.0385709144175053, -0.9469701051712036, -0.7632235288619995, 0.6076294183731079, -1.0984325408935547, 1.8977717161178589, -1.4533600807189941, -0.4817864298820496, -0.6665986180305481, 2.0460472106933594, -0.6202226281166077, -1.5980435609817505, -0.5314854383468628, 0.1887078285217285, -0.9948600530624390, -2.0106642246246338, -0.3946736752986908, -0.2213082015514374, -0.1460758894681931, -1.3876315355300903, 0.8427582979202271, -0.6279100179672241, 0.0503720529377460, 0.7906651496887207, -1.9770774841308594, 1.2336332798004150, -1.6072020530700684, 0.2002114206552506, 0.1609606593847275, -0.9645853042602539, -0.1966949254274368, -2.3219172954559326, 0.6475968956947327, -0.1468921750783920, -0.0713737010955811, -0.5773155689239502, 1.0463010072708130, 1.4515222311019897, -0.4010011553764343, 0.8491577506065369, -0.7516176104545593, 1.3422669172286987, -0.5378456711769104, -0.3807033896446228, -0.6741384863853455, 0.4434496760368347, 0.2441450953483582, -0.5138993859291077, -1.6812496185302734, -1.9694640636444092, -0.0013819192536175, 0.2167512625455856, 0.8642961382865906, -1.1354254484176636, 0.8516390919685364, -0.4266323745250702, -1.5852692127227783];
a = mshape(a,[20,20,2]);
Y = [-0.1331594288349152, -0.0475295111536980];
Y = mshape(Y,[1,1,2]);
B = [0.0451052226126194, 0.0712474808096886];
B = mshape(B,[1,1,2]);
t = a*-2+2;
t(:,:,1) = t(:,:,1)*-1
function y = mmedia(x)
  y = zeros(1,1,size(x,3));
  for i = 1:size(x,3)
    y(i) = mean(x(:,:,i)'(:));
  end
end
function y = mvariancia(x)
  y = zeros(1,1,size(x,3));
  for i = 1:size(x,3)
    y(i) = var(x(:,:,i)'(:),1);
  end
end
function y = mmax(x)
  y = zeros(1,1,size(x,3));
  for i = 1:size(x,3)
    y(i) = max(x(:,:,i)'(:));
  end
end
function y = mmin(x)
  y = zeros(1,1,size(x,3));
  for i = 1:size(x,3)
    y(i) = min(x(:,:,i)'(:));
  end
end
function y = msoma(x)
  y = zeros(1,1,size(x,3));
  for i = 1:size(x,3)
    y(i) = sum(x(:,:,i)'(:));
  end
end
mse_ = [];
h = 1e-3; % hitlearn

for kk = 1:40 %% simula as epocas
mu = mmedia(a); %% acha a média de camada dimensão z
o_2 = mvariancia(a); % acha a variâcia
o_inv = 1 ./sqrt(o_2 +1e-12); % 1 sobre o desvio padrão
norma = ( a - mu ) .* o_inv; % normaliza, aqui o sinal tem média 0 e desvio e variancia 1

s =  norma .* Y + B; %% modifica o desvio padrão para Y e a media para B

ds = s - t; % calcula o ultimo gradiente
dnorm = ds .* Y; % gradiente dos valores normalizados d( norm .* Y + B)/dnorm = Y
da = o_inv .* (dnorm - mmedia(dnorm)  - norma .* mmedia(dnorm.*norma)); % gradiiente da entrada (não fiz os calculos)
dY = msoma(ds .* norma); %% gradient de Gamma
dB = msoma(ds);%% Gradiente de Beta
Y = Y - h*dY; %% ajusta os pesos sem momento e decaimento
B = B - h*dB;%% ajusta os pesos sem momento e decaimento
mse = sum((ds.^2)(:))/(length(ds(:))); % verificar convergência
mse_ = [mse_ mse]; 
subplot(211)
plot(mse_);title('mse batchnorm')
subplot(212)
plot(Y(:));hold on;
plot(B(:));hold off;legend('{\gamma}','{\beta}')
drawnow
end
