clc;close all;clear all
a = [0.3600037992000580, 1.9672887325286865, 0.9913624525070190, 1.0116829872131348, -0.0628277286887169, 0.9846172332763672, -0.1690516322851181, -0.6491651535034180, -1.1233893632888794, -0.7702767252922058, 0.1888358443975449, 1.1022206544876099, 2.0000338554382324, 0.9188330173492432, -1.1673563718795776, 0.4895208775997162, 0.8545905947685242, -1.0134210586547852, 1.1172251701354980, 0.5495119690895081, 1.4158734083175659, 0.5630170106887817, 1.8350275754928589, 0.0435619056224823];
a = mshape(a,[12,2]);
mx = [1.9672887325286865, 1.0116829872131348, 0.9846172332763672, -0.1690516322851181, -0.7702767252922058, 1.1022206544876099, 2.0000338554382324, 0.4895208775997162, 0.8545905947685242, 1.1172251701354980, 1.4158734083175659, 1.8350275754928589];
mx = mshape(mx,[12,1]);
imx = [1, 1, 1, 0, 1, 1, 0, 1, 0, 0, 0, 0];
imx = mshape(imx,[12,1]);
ex = [0.2004310637712479, 1.0000000000000000, 0.9798845052719116, 1.0000000000000000, 0.3508329987525940, 1.0000000000000000, 1.0000000000000000, 0.6187131404876709, 0.7024980187416077, 1.0000000000000000, 0.4011640548706055, 1.0000000000000000, 1.0000000000000000, 0.3391879498958588, 0.1907336562871933, 1.0000000000000000, 1.0000000000000000, 0.1544304043054581, 1.0000000000000000, 0.5668201446533203, 1.0000000000000000, 0.4261958003044128, 1.0000000000000000, 0.1667156368494034];
ex = mshape(ex,[12,2]);
soma = [1.2004311084747314, 1.9798845052719116, 1.3508329391479492, 1.6187131404876709, 1.7024979591369629, 1.4011640548706055, 1.3391879796981812, 1.1907336711883545, 1.1544303894042969, 1.5668201446533203, 1.4261958599090576, 1.1667156219482422];
soma = mshape(soma,[12,1]);
s = [0.1669659018516541, 0.8330340385437012, 0.4949200451374054, 0.5050799846649170, 0.2597160339355469, 0.7402839660644531, 0.6177746653556824, 0.3822253048419952, 0.4126277863979340, 0.5873721837997437, 0.2863076925277710, 0.7136923074722290, 0.7467211484909058, 0.2532788217067719, 0.1601816266775131, 0.8398183584213257, 0.8662280440330505, 0.1337719410657883, 0.6382353305816650, 0.3617646396160126, 0.7011659741401672, 0.2988339960575104, 0.8571069240570068, 0.1428931206464768];
s = mshape(s,[12,2]);
mxm = max(a')';
imxm = find(a'==mxm') - [1:size(a,2):size(a,2)*size(a,1)]';
exm = exp(a-mxm);
figure;hold on;
plot(mx(:),'DisplayName','mx')
plot(mxm(:),'DisplayName','mxm')
title('"mx" vs "mxm"');
legend();
if gcf() == 1
print('softmax.c.pdf')
else print('softmax.c.pdf', '-append'); end;
figure;hold on;
plot(imx(:),'DisplayName','imx')
plot(imxm(:),'DisplayName','imxm')
title('"imx" vs "imxm"');
legend();
if gcf() == 1
print('softmax.c.pdf')
else print('softmax.c.pdf', '-append'); end;
somam = sum(exm')';sm = exm./somam;

t = [0.4366275072097778, -0.3643586933612824, 0.6368808746337891, -1.3570647239685059, 0.8985430002212524, -2.0514209270477295, 0.6161060929298401, -0.8296238780021668, 0.6318564414978027, 1.7406560182571411, -2.0779869556427002, 0.2767087519168854, 0.3173953592777252, 0.8788203001022339, -0.1101800799369812, -1.1485702991485596, -0.1211733072996140, -1.0809378623962402, 0.6891072392463684, -1.4367465972900391, 2.3770225048065186, 0.8591832518577576, 0.6639763712882996, 1.5504533052444458];
t = mshape(t,[12,2]);
ds = [-0.2696616053581238, 1.1973927021026611, -0.1419608294963837, 1.8621447086334229, -0.6388269662857056, 2.7917048931121826, 0.0016685724258423, 1.2118492126464844, -0.2192286550998688, -1.1532838344573975, 2.3642945289611816, 0.4369835555553436, 0.4293257892131805, -0.6255414485931397, 0.2703617215156555, 1.9883886575698853, 0.9874013662338257, 1.2147097587585449, -0.0508719086647034, 1.7985112667083740, -1.6758565902709961, -0.5603492259979248, 0.1931305527687073, -1.4075602293014526];
ds = mshape(ds,[12,2]);
da = [-1.4670543670654297, 0.0000000000000000, -2.0041055679321289, 0.0000000000000000, -3.4305319786071777, 0.0000000000000000, 0.0000000000000000, 1.2101806402206421, 0.9340552091598511, 0.0000000000000000, 1.9273109436035156, 0.0000000000000000, 0.0000000000000000, -1.0548672676086426, -1.7180268764495850, 0.0000000000000000, 0.0000000000000000, 0.2273083925247192, 0.0000000000000000, 1.8493831157684326, 0.0000000000000000, 1.1155073642730713, 0.0000000000000000, -1.6006908416748047];
da = mshape(da,[12,2]);
sds = [-0.2696616053581238, 1.1973927021026611, -0.1419608294963837, 1.8621447086334229, -0.6388269662857056, 2.7917048931121826, 0.0016685724258423, 1.2118492126464844, -0.2192286550998688, -1.1532838344573975, 2.3642945289611816, 0.4369835555553436, 0.4293257892131805, -0.6255414485931397, 0.2703617215156555, 1.9883886575698853, 0.9874013662338257, 1.2147097587585449, -0.0508719086647034, 1.7985112667083740, -1.6758565902709961, -0.5603492259979248, 0.1931305527687073, -1.4075602293014526];
sds = mshape(sds,[12,2]);
figure;hold on;
plot(ex(:),'DisplayName','ex')
plot(exm(:),'DisplayName','exm')
title('"ex" vs "exm"');
legend();
if gcf() == 1
print('softmax.c.pdf')
else print('softmax.c.pdf', '-append'); end;
figure;hold on;
plot(soma(:),'DisplayName','soma')
plot(somam(:),'DisplayName','somam')
title('"soma" vs "somam"');
legend();
if gcf() == 1
print('softmax.c.pdf')
else print('softmax.c.pdf', '-append'); end;
figure;hold on;
plot(s(:),'DisplayName','s')
plot(sm(:),'DisplayName','sm')
title('"s" vs "sm"');
legend();
if gcf() == 1
print('softmax.c.pdf')
else print('softmax.c.pdf', '-append'); end;
dsm = sm - t;
tmp = reshape([0:size(dsm,2)^2-1],size(dsm,2),size(dsm,2))';
i = floor(tmp/size(a,2));
j = mod(tmp,size(a,2));
tmp = (i==j)-(j==reshape(imxm,[1,1,size(imxm,1)]));
grad = dsm;
dam = a*0;
for z = 1:size(dam,1)
  dam(z,:) = tmp(:,:,z) * (grad(z,:)');
end

figure;hold on;
plot(ds(:),'DisplayName','ds')
plot(dsm(:),'DisplayName','dsm')
title('"ds" vs "dsm"');
legend();
if gcf() == 1
print('softmax.c.pdf')
else print('softmax.c.pdf', '-append'); end;
figure;hold on;
plot(da(:),'DisplayName','da')
plot(dam(:),'DisplayName','dam')
title('"da" vs "dam"');
legend();
if gcf() == 1
print('softmax.c.pdf')
else print('softmax.c.pdf', '-append'); end;
